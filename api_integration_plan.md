# API統合計画書

## 1. 概要

本計画書は、パートナー要員管理システム（PMS）のフロントエンドにおいて、現在使用されているモックデータから本番環境APIへの移行を実現するための具体的な実装計画を示すものです。

## 2. 現状分析

コードベースの分析結果から、以下の現状が確認されました：

1. 各サービスファイル（userService.ts、projectService.tsなど）では、実際のAPIエンドポイント呼び出しがコメントアウトされており、代わりにハードコードされたモックデータが使用されています。
2. 現在のapi.tsは基本的なHTTPメソッド（GET、POST、PUT、PATCH、DELETE）を提供していますが、環境変数による制御やエラーハンドリングの強化などの機能は実装されていません。
3. callWithRetry関数は既に実装されていますが、USE_MOCK_DATA変数はまだ実装されていません。

## 3. 移行戦略

移行は以下の戦略で進めます：

1. **段階的移行**: すべてのサービスを一度に移行するのではなく、モジュール単位で段階的に移行します。
2. **環境変数による制御**: 開発環境と本番環境を環境変数で切り替えられるようにします。
3. **フォールバック機構**: 本番APIが利用できない場合にモックデータにフォールバックする仕組みを実装します。
4. **エラーハンドリングの強化**: 統一的なエラーハンドリング機構を実装します。

## 4. 実装計画

### 4.1 API基盤の整備

#### 4.1.1 環境変数の設定

`.env.development`と`.env.production`ファイルを作成し、環境変数を設定します。

```
# .env.development
VITE_API_BASE_URL=http://localhost:3000/api
VITE_USE_MOCK_DATA=true

# .env.production
VITE_API_BASE_URL=https://api.example.com
VITE_USE_MOCK_DATA=false
```

#### 4.1.2 API基盤の強化

`api.ts`ファイルを修正し、環境変数による制御、インターセプター、エラーハンドリングの強化などの機能を実装します。

### 4.2 モックデータの分離

各サービスファイルからモックデータを分離し、専用のモックデータファイルに移動します。

```
/src
  /mocks
    userMock.ts
    projectMock.ts
    staffMock.ts
    partnerMock.ts
    ...
```

### 4.3 サービスファイルの修正

各サービスファイルを修正し、環境変数に基づいてAPIエンドポイントまたはモックデータを使用するように変更します。

### 4.4 エラーハンドリングの強化

統一的なエラーハンドリング機構を実装し、ユーザーフレンドリーなエラーメッセージを表示できるようにします。

### 4.5 テスト戦略の実装

単体テストと統合テストを実装し、APIエンドポイントとの連携を検証します。

## 5. 実装順序

以下の順序で実装を進めます：

1. **API基盤の整備**
   - 環境変数の設定
   - api.tsの強化

2. **モックデータの分離**
   - userMock.ts
   - projectMock.ts
   - staffMock.ts
   - partnerMock.ts
   - その他のモックデータファイル

3. **コアサービスの修正**
   - userService.ts
   - projectService.ts
   - staffService.ts
   - partnerService.ts

4. **補助サービスの修正**
   - contractService.ts
   - evaluationService.ts
   - applicationService.ts
   - その他のサービス

5. **エラーハンドリングの強化**
   - errorHandler.tsの実装
   - エラー表示コンポーネントの実装

6. **テスト戦略の実装**
   - 単体テストの実装
   - 統合テストの実装

## 6. 詳細実装計画

### 6.1 API基盤の整備

#### 6.1.1 環境変数の設定

`.env.development`と`.env.production`ファイルを作成します。

#### 6.1.2 API基盤の強化

`api.ts`ファイルを修正し、以下の機能を実装します：

- 環境変数からのベースURL取得
- 認証トークンの自動設定
- リクエスト・レスポンスインターセプター
- エラーハンドリング
- リトライ機能

### 6.2 モックデータの分離

各サービスファイルからモックデータを抽出し、専用のモックデータファイルに移動します。

### 6.3 サービスファイルの修正

各サービスファイルを修正し、環境変数に基づいてAPIエンドポイントまたはモックデータを使用するように変更します。

### 6.4 エラーハンドリングの強化

`errorHandler.ts`ファイルを作成し、統一的なエラーハンドリング機構を実装します。

### 6.5 テスト戦略の実装

単体テストと統合テストを実装し、APIエンドポイントとの連携を検証します。

## 7. リスクと対策

1. **APIの仕様変更**
   - リスク: バックエンドAPIの仕様が変更される可能性がある
   - 対策: APIクライアントに型定義を導入し、型安全性を確保する

2. **パフォーマンスの低下**
   - リスク: モックデータからAPIへの切り替えによりレスポンス時間が増加する可能性がある
   - 対策: キャッシュ機構の導入、ページネーションの最適化

3. **認証・認可の問題**
   - リスク: 本番環境ではトークンベースの認証が必要になる
   - 対策: 認証トークンの管理機構を実装し、期限切れの自動更新を行う

4. **ネットワーク障害**
   - リスク: ネットワーク接続の問題でAPIにアクセスできない場合がある
   - 対策: リトライ機構、オフラインモード、エラー表示の改善

## 8. スケジュール

移行は以下のスケジュールで進めます：

1. **準備フェーズ（1週間）**
   - 環境変数の設定
   - API基盤の強化
   - モックデータの分離

2. **コア機能の移行（2週間）**
   - userService.ts
   - projectService.ts
   - staffService.ts
   - partnerService.ts

3. **補助機能の移行（2週間）**
   - contractService.ts
   - evaluationService.ts
   - applicationService.ts
   - その他のサービス

4. **テストと検証（1週間）**
   - 単体テスト
   - 統合テスト
   - エンドツーエンドテスト

5. **本番環境への展開（1週間）**
   - ステージング環境でのテスト
   - 本番環境への展開
   - モニタリングと問題対応

## 9. 結論

この移行計画に従って実装を進めることで、モックデータから本番環境APIへのスムーズな移行が可能になります。環境変数による制御とフォールバック機構により、開発環境と本番環境の切り替えが容易になり、段階的な移行とテストが可能になります。
